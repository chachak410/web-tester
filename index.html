<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Design Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      overflow: hidden;
      width: 100%;
      max-width: 600px;
      margin: 20px;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.2em;
      margin-bottom: 10px;
      font-weight: 300;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .content {
      padding: 40px 30px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #6c757d;
      margin-top: 10px;
    }

    .btn-small {
      width: auto;
      padding: 10px 20px;
      font-size: 14px;
      margin: 5px;
    }

    .message {
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: 500;
    }

    .message.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ffcdd2;
    }

    .message.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }

    .message.info {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #bbdefb;
    }

    .switch-link {
      text-align: center;
      margin-top: 25px;
    }

    .switch-link a {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
    }

    .switch-link a:hover {
      text-decoration: underline;
    }

    .hidden {
      display: none !important;
    }

    .main-app {
      display: none;
      min-height: 100vh;
      width: 100%;
      background: #f8f9fa;
    }

    .main-app.show {
      display: block;
    }

    .app-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .app-header h1 {
      font-size: 1.8em;
      font-weight: 300;
    }

    .nav-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      margin-left: 10px;
    }

    .nav-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .app-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .controls {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 25px;
      align-items: end;
    }

    .row > * {
      flex: 1;
      min-width: 200px;
    }

    .generate-btn {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    .card img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      display: inline-block;
      margin-bottom: 10px;
    }

    .status {
      margin: 15px 0;
      padding: 12px;
      border-radius: 8px;
      font-weight: 500;
    }

    .status-working {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #bbdefb;
    }

    .status-success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }

    .status-error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ffcdd2;
    }

    .template-list {
      margin-bottom: 20px;
    }

    .template-list label {
      display: block;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      .row {
        flex-direction: column;
      }

      .row > * {
        min-width: unset;
      }

      .app-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Authentication Container -->
  <div id="auth-container" class="container">
    <div class="header">
      <h1>ðŸŽ¨ AI Design Generator</h1>
      <p>Create stunning images with AI</p>
    </div>

    <div class="content">
      <!-- Login Form -->
      <form id="login-form">
        <div class="form-group">
          <label for="login-email">Email Address</label>
          <input id="login-email" type="email" required autocomplete="username" placeholder="Enter your email">
        </div>
        <div class="form-group">
          <label for="login-password">Password</label>
          <input id="login-password" type="password" required autocomplete="current-password" placeholder="Enter your password">
        </div>
        <button type="submit" class="btn">Sign In</button>
        <div id="login-msg" class="message" style="display: none;"></div>
      </form>

      <!-- Registration Form -->
      <form id="register-form" class="hidden">
        <div class="form-group">
          <label for="register-email">Email Address</label>
          <input id="register-email" type="email" required autocomplete="username" placeholder="Enter your email">
        </div>
        <div class="form-group">
          <label for="register-password">Password</label>
          <input id="register-password" type="password" required autocomplete="new-password" placeholder="Create a password">
        </div>
        <div class="form-group">
          <label for="register-code">Industry Code</label>
          <input id="register-code" type="text" required placeholder="Enter industry code (e.g., 000000)">
        </div>
        <button type="submit" class="btn">Create Account</button>
        <div id="register-msg" class="message" style="display: none;"></div>
      </form>

      <div class="switch-link">
        <span id="switch-to-register">Don't have an account? <a href="#" onclick="showRegister(); return false;">Sign up</a></span>
        <span id="switch-to-login" class="hidden">Already have an account? <a href="#" onclick="showLogin(); return false;">Sign in</a></span>
      </div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="main-app" class="main-app">
    <div class="app-header">
      <h1>ðŸŽ¨ AI Design Generator</h1>
      <div>
        <button id="setup-btn" class="nav-btn">Setup</button>
        <button id="account-btn" class="nav-btn">Account</button>
        <button id="template-btn" class="nav-btn">Templates</button>
        <button id="records-btn" class="nav-btn">Past Records</button>
        <button id="master-btn" class="nav-btn hidden">Master Controls</button>
        <button id="logout-btn" class="nav-btn">Logout</button>
      </div>
    </div>

    <div class="app-content">
      <!-- Setup Page -->
      <div id="setup-page" class="controls hidden">
        <h2>Setup Your Profile</h2>
        <form id="setup-form">
          <div class="form-group">
            <label for="setup-name">Full Name</label>
            <input id="setup-name" type="text" required placeholder="Enter your full name">
          </div>
          <div class="form-group">
            <label for="setup-details">Additional Details</label>
            <textarea id="setup-details" placeholder="Optional details"></textarea>
          </div>
          <button type="submit" class="btn">Save Profile</button>
          <div id="setup-msg" class="message" style="display: none;"></div>
        </form>
      </div>

      <!-- Account Page -->
      <div id="account-page" class="controls hidden">
        <h2>Account Information</h2>
        <div id="account-info"></div>
        <form id="account-form">
          <div class="form-group">
            <label for="account-name">Full Name</label>
            <input id="account-name" type="text" required placeholder="Enter your full name">
          </div>
          <div class="form-group">
            <label for="account-details">Additional Details</label>
            <textarea id="account-details" placeholder="Optional details"></textarea>
          </div>
          <button type="submit" class="btn">Update Profile</button>
          <div id="account-msg" class="message" style="display: none;"></div>
        </form>
      </div>

      <!-- Template Page -->
      <div id="template-page" class="controls hidden">
        <h2>Select Template</h2>
        <div id="template-list" class="template-list"></div>
        <button id="generate-images" class="btn generate-btn">âœ¨ Generate Images</button>
        <div id="template-status" class="status"></div>
        <div id="generated-images" class="grid"></div>
        <div id="feedback-section" class="hidden">
          <button id="like-first" class="btn btn-small">I like this</button>
          <button id="like-second" class="btn btn-small">I like that</button>
          <button id="both-bad" class="btn btn-small">Both bad</button>
        </div>
      </div>

      <!-- Past Records Page -->
      <div id="records-page" class="controls hidden">
        <h2>Past Records</h2>
        <div id="records-list" class="grid"></div>
      </div>

      <!-- Master Controls Page -->
      <div id="master-page" class="controls hidden">
        <h2>Master Controls</h2>
        <div class="form-group">
          <label for="template-name">Create New Template</label>
          <input id="template-name" type="text" placeholder="Enter template name">
          <button id="create-template" class="btn btn-small">Create Template</button>
        </div>
        <div class="form-group">
          <label for="template-file">Upload Template File (XLSX)</label>
          <input id="template-file" type="file" accept=".xlsx">
          <button id="upload-template" class="btn btn-small">Upload Templates</button>
        </div>
        <div id="template-management"></div>
        <div class="form-group">
          <label for="industry-code">Generate Industry Code</label>
          <input id="industry-code" type="text" readonly>
          <button id="generate-code" class="btn btn-small">Generate Code</button>
        </div>
        <div id="master-msg" class="message" style="display: none;"></div>
      </div>
    </div>
  </div>

  <script>
    // EmailJS Configuration
    const EMAILJS_SERVICE_ID = 'service_ghvr7ui';
    const EMAILJS_TEMPLATE_ID = 'template_x4lt4dk';
    emailjs.init('gtluK1AW_Y5bE9mVp');

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBtF_37PsX1ItQobFZkOVSMUEio2NPmdoM",
      authDomain: "login-system-ae45f.firebaseapp.com",
      projectId: "login-system-ae45f",
      storageBucket: "login-system-ae45f.firebasestorage.app",
      messagingSenderId: "178893070717",
      appId: "1:178893070717:web:e2bc8f79ce87f85391ec14",
      measurementId: "G-Y4H7X7DJ88"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Global state
    let currentUser = null;
    let userRole = null;
    let userData = {};
    let bothBadCount = 0;
    const MAX_BOTH_BAD = 20;

    // XLSX Processing
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }

    async function processXlsxFile(file) {
      try {
        const reader = new FileReader();
        return new Promise((resolve, reject) => {
          reader.onload = function(e) {
            try {
              const data = e.target.result.split(',')[1]; // Get base64 data
              const workbook = XLSX.read(data, { type: 'base64' });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
              const filteredData = jsonData.filter(row => row.some(filledCell));
              const headerRowIndex = filteredData.findIndex((row, index) =>
                row.filter(filledCell).length >= (filteredData[index + 1]?.filter(filledCell).length || 0)
              );
              const startIndex = headerRowIndex === -1 || headerRowIndex > 25 ? 0 : headerRowIndex;
              const templates = filteredData.slice(startIndex).map(row => row[0]?.toString().trim()).filter(name => name);
              resolve(templates);
            } catch (err) {
              reject(err);
            }
          };
          reader.onerror = () => reject(new Error('File reading failed'));
          reader.readAsDataURL(file);
        });
      } catch (err) {
        console.error('XLSX processing error:', err);
        throw err;
      }
    }

    // UI Helper Functions
    function showElement(id) {
      const el = document.getElementById(id);
      if (el) el.classList.remove('hidden');
    }

    function hideElement(id) {
      const el = document.getElementById(id);
      if (el) el.classList.add('hidden');
    }

    function showMessage(id, message, type = 'info') {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = message;
        el.className = `message ${type}`;
        el.style.display = 'block';
      }
    }

    function hideMessage(id) {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none
