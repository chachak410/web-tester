<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Design Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* Your existing styles remain unchanged */
  </style>
</head>
<body>
  <!-- Your existing HTML structure remains unchanged -->

  <script>
    // Your security rules comment remains unchanged

    // EmailJS and Firebase config remain unchanged

    // Global state remains unchanged

    // XLSX Processing remains unchanged

    // UI Helper Functions remain unchanged

    // Authentication Functions with added error handling
    async function handleLogin(email, password) {
      try {
        showMessage('login-msg', 'Signing in...', 'info');
        const result = await auth.signInWithEmailAndPassword(email, password);
        currentUser = result.user;
        await loadUserData();
        if (!userData || !userData.role) {
          throw new Error('User data not loaded. Please re-register or contact support.');
        }
        hideMessage('login-msg');
        showMainApp();
      } catch (err) {
        console.error('Login error:', err);
        let message = 'Login failed. Please check your credentials.';
        // Your existing error messages...
        showMessage('login-msg', message, 'error');
      }
    }

    async function handleRegister(email, password, code) {
      try {
        showMessage('register-msg', 'Creating account...', 'info');
        if (code !== '000000') {
          const templateDoc = await db.collection('templates').where('code', '==', code).get();
          if (templateDoc.empty) {
            throw new Error('Invalid industry code.');
          }
        }
        const result = await auth.createUserWithEmailAndPassword(email, password);
        currentUser = result.user;
        const role = code === '000000' ? 'master' : 'client';
        await db.collection('users').doc(currentUser.uid).set({
          email,
          role,
          industryCode: code,
          name: '',
          details: '',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        // Verify doc was created
        const verifyDoc = await db.collection('users').doc(currentUser.uid).get();
        if (!verifyDoc.exists) {
          throw new Error('Failed to create user data. Check Firestore rules.');
        }
        userData = verifyDoc.data();
        userRole = role;
        showMessage('register-msg', 'Account created successfully!', 'success');
        setTimeout(() => showMainApp(), 1000);
      } catch (err) {
        console.error('Registration error:', err);
        showMessage('register-msg', err.message, 'error');
      }
    }

    // resetPassword, loadUserData (with auto-fix), handleLogout remain unchanged, but add console.log in loadUserData for debugging
    async function loadUserData() {
      if (!currentUser) return;
      try {
        const doc = await db.collection('users').doc(currentUser.uid).get();
        if (doc.exists) {
          userData = doc.data();
          userRole = userData.role || 'client';
          if ((userData.industryCode === '000000' || userData.email === MASTER_EMAIL) && userRole !== 'master') {
            userRole = 'master';
            await db.collection('users').doc(currentUser.uid).update({ role: 'master' });
            console.log('Auto-fixed role to master');
          }
        } else {
          throw new Error('No user data found. Re-register or check Firestore.');
        }
      } catch (err) {
        console.error('Error loading user data:', err);
        showMessage('login-msg', err.message, 'error');
      }
    }

    // Setup and Account Functions remain unchanged

    // Template Functions remain unchanged, but add hideElement('feedback-section') in loadTemplates for reset

    async function loadTemplates() {
      // Existing code...
      hideElement('feedback-section');
      // Existing code...
    }

    // generateImages, generateTwoImages, renderGeneratedImages, saveGenerationRecord, handleFeedback, loadRecords, downloadImage remain unchanged

    // Master Functions remain unchanged

    // Image Generation Functions remain unchanged

    // Event Listeners remain unchanged, with DOMContentLoaded init
  </script>
</body>
</html>
